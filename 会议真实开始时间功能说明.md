# ä¼šè®®çœŸå®å¼€å§‹æ—¶é—´è·å–ä¸æ’åºä¼˜åŒ–

## éœ€æ±‚èƒŒæ™¯

åŸæœ‰çš„å¾…åŠäº‹é¡¹æ’åºåŠŸèƒ½å­˜åœ¨ä»¥ä¸‹é—®é¢˜ï¼š
1. ä¼šè®®å¾…åŠäº‹é¡¹æŒ‰åˆ›å»ºæ—¶é—´æ’åºï¼Œæ— æ³•åæ˜ ä¼šè®®å®é™…å‘ç”Ÿçš„æ—¶é—´é¡ºåº
2. ç”¨æˆ·æ— æ³•æŒ‰ä¼šè®®çœŸå®å¼€å§‹æ—¶é—´æŸ¥çœ‹å¾…åŠäº‹é¡¹
3. æ’åºé€»è¾‘ä¸å¤Ÿå‡†ç¡®ï¼Œå½±å“ç”¨æˆ·ä½“éªŒ

## è§£å†³æ–¹æ¡ˆ

é›†æˆ `meeting_time.py` çš„åŠŸèƒ½ï¼Œè·å–ä¼šè®®çš„çœŸå®å¼€å§‹æ—¶é—´ï¼Œå¹¶ä¼˜åŒ–æ’åºé€»è¾‘ã€‚

## å®ç°ç»†èŠ‚

### 1. åç«¯ä¿®æ”¹

#### 1.1 ä¿®æ”¹ `url_crawler.py`

**æ–‡ä»¶**: `backend/url_crawler.py`

**ä¿®æ”¹ç‚¹**:
- `get_meeting_params()` å‡½æ•°ï¼šæ–°å¢è·å–çœŸå®å¼€å§‹æ—¶é—´é€»è¾‘
- `crawl_meeting_summary_api()` å‡½æ•°ï¼šè¿”å›ç»“æœä¸­åŒ…å« `real_start_time`
- `crawl_meeting_api()` å‡½æ•°ï¼šç¡®ä¿æ‰€æœ‰è·¯å¾„éƒ½è¿”å›çœŸå®å¼€å§‹æ—¶é—´

**æ ¸å¿ƒä»£ç **:
```python
def get_meeting_params(share_url, user_cookie: Optional[str] = None):
    # ... åŸæœ‰é€»è¾‘ ...
    
    # è·å–çœŸå®å¼€å§‹æ—¶é—´ (å¤ç”¨ meeting_time.py é€»è¾‘)
    raw_start_time = meeting_info.get("start_time")
    real_start_time = None
    if raw_start_time:
        try:
            # è…¾è®¯è¿”å›çš„æ˜¯13ä½æ¯«ç§’çº§æ—¶é—´æˆ³ï¼Œé™¤ä»¥1000è½¬ä¸ºç§’
            ts = int(raw_start_time) / 1000
            real_start_time = dt.fromtimestamp(ts)
            logger.info(f"ğŸ“… è·å–ä¼šè®®çœŸå®å¼€å§‹æ—¶é—´: {real_start_time.strftime('%Y/%m/%d %H:%M:%S')}")
        except Exception as e:
            logger.warning(f"âš ï¸ è§£æå¼€å§‹æ—¶é—´å¤±è´¥: {e}")
    
    return sharing_id, meeting_id, record_id, meeting_title, real_start_time

def crawl_meeting_summary_api(share_url, user_cookie: Optional[str] = None):
    # ... åŸæœ‰é€»è¾‘ ...
    return {
        "title": meeting_title or "ä¼šè®®çºªè¦",
        "summary": summary_text,
        "transcript": "",
        "todos": todos,
        "personal_todos": todos,
        "real_start_time": real_start_time  # æ–°å¢å­—æ®µ
    }
```

#### 1.2 ä¿®æ”¹ `server_receive.py`

**æ–‡ä»¶**: `backend/server_receive.py`

**ä¿®æ”¹ç‚¹**:
- `save_meeting_data_to_db()` å‡½æ•°ï¼šä½¿ç”¨çœŸå®å¼€å§‹æ—¶é—´ä¿å­˜ä¼šè®®è®°å½•

**æ ¸å¿ƒä»£ç **:
```python
def save_meeting_data_to_db(crawl_result, system_user_id: Optional[str], meeting_url: str = ""):
    # è·å–çœŸå®å¼€å§‹æ—¶é—´
    real_start_time = crawl_result.get("real_start_time")
    if real_start_time:
        logger.info(f"ğŸ“… ä½¿ç”¨ä¼šè®®çœŸå®å¼€å§‹æ—¶é—´: {real_start_time}")
    else:
        real_start_time = datetime.now()
        logger.info("âš ï¸ æœªè·å–åˆ°çœŸå®å¼€å§‹æ—¶é—´ï¼Œä½¿ç”¨å½“å‰æ—¶é—´ä½œä¸ºä¼šè®®æ—¶é—´")
    
    # ä¿å­˜ä¼šè®®è®°å½• - ä½¿ç”¨çœŸå®å¼€å§‹æ—¶é—´
    new_meeting = Meeting(
        id=str(uuid.uuid4()),
        organizer_id=user_id,
        title=clean_text(smart_title),
        start_time=real_start_time,  # ä½¿ç”¨çœŸå®å¼€å§‹æ—¶é—´
        end_time=real_start_time,    # åŒæ ·ä½¿ç”¨çœŸå®å¼€å§‹æ—¶é—´
        location=meeting_url or "è…¾è®¯ä¼šè®®",
        # ... å…¶ä»–å­—æ®µ ...
    )
```

### 2. å‰ç«¯æ”¯æŒ

å‰ç«¯ä»£ç å·²å®ç°åŠ¨æ€æ—¶é—´æ˜¾ç¤ºåŠŸèƒ½ï¼š

**æ–‡ä»¶**: `components/TodoView.tsx`

**æ ¸å¿ƒé€»è¾‘**:
```tsx
{sortBy === 'meeting_time' && item.meeting_time 
  ? <><Calendar size={10} className="inline mr-1" />{item.meeting_time}</>
  : <><Clock size={10} className="inline mr-1" />{item.time}</>
}
```

å½“ç”¨æˆ·é€‰æ‹©æŒ‰"ä¼šè®®æ—¶é—´"æ’åºæ—¶ï¼š
- æ˜¾ç¤º Calendar å›¾æ ‡ + çœŸå®ä¼šè®®å¼€å§‹æ—¶é—´
- æœ‰ä¼šè®®çš„å¾…åŠæ’åœ¨å‰é¢ï¼ŒæŒ‰ä¼šè®®æ—¶é—´å€’åº
- æ— ä¼šè®®çš„å¾…åŠæ’åœ¨åé¢ï¼ŒæŒ‰ç”Ÿæˆæ—¶é—´å€’åº

å½“ç”¨æˆ·é€‰æ‹©æŒ‰"ç”Ÿæˆæ—¶é—´"æ’åºæ—¶ï¼š
- æ˜¾ç¤º Clock å›¾æ ‡ + ä»»åŠ¡åˆ›å»ºæ—¶é—´
- æŒ‰ä»»åŠ¡åˆ›å»ºæ—¶é—´å€’åºæ’åˆ—

### 3. API æ¥å£

**æ¥å£**: `GET /api/todos?sort_by=meeting_time`

**å‚æ•°**:
- `sort_by`: "created_at" (é»˜è®¤) | "meeting_time"

**å“åº”ç¤ºä¾‹**:
```json
[
  {
    "id": "uuid",
    "title": "ä¼šè®®å¾…åŠäº‹é¡¹",
    "time": "2026/02/27 14:30:00",
    "meeting_time": "2026/02/27 10:00",
    "sender": "ä¼šè®®åŠ©æ‰‹",
    "priority": "high",
    "status": "pending"
  }
]
```

## æµ‹è¯•éªŒè¯

åˆ›å»ºäº†å®Œæ•´çš„æµ‹è¯•è„šæœ¬ `test_real_meeting_time.py`ï¼ŒåŒ…å«å››ä¸ªæµ‹è¯•ç”¨ä¾‹ï¼š

1. **æµ‹è¯• get_meeting_params è·å–çœŸå®å¼€å§‹æ—¶é—´**
2. **æµ‹è¯• crawl_meeting_api è¿”å› real_start_time**
3. **æµ‹è¯• save_meeting_data_to_db ä½¿ç”¨çœŸå®å¼€å§‹æ—¶é—´**
4. **æµ‹è¯•æ’åºé€»è¾‘**

## åŠŸèƒ½æ•ˆæœ

### ç”¨æˆ·ä½“éªŒæå‡

1. **å‡†ç¡®çš„æ—¶é—´æ’åº**ï¼šå¾…åŠäº‹é¡¹æŒ‰ä¼šè®®å®é™…å‘ç”Ÿæ—¶é—´æ’åºï¼Œæ›´ç¬¦åˆç”¨æˆ·é¢„æœŸ
2. **æ¸…æ™°çš„æ—¶é—´æ ‡è¯†**ï¼š
   - Calendar å›¾æ ‡ + ä¼šè®®æ—¶é—´ï¼šæ˜¾ç¤ºä¼šè®®å®é™…å¼€å§‹æ—¶é—´
   - Clock å›¾æ ‡ + ç”Ÿæˆæ—¶é—´ï¼šæ˜¾ç¤ºä»»åŠ¡åˆ›å»ºæ—¶é—´
3. **çµæ´»çš„æ’åºé€‰é¡¹**ï¼šç”¨æˆ·å¯è‡ªç”±åˆ‡æ¢æŒ‰ä¼šè®®æ—¶é—´æˆ–ç”Ÿæˆæ—¶é—´æ’åº

### æŠ€æœ¯ä¼˜åŠ¿

1. **å¤ç”¨ç°æœ‰åŠŸèƒ½**ï¼šé›†æˆ `meeting_time.py` çš„æˆç†Ÿé€»è¾‘
2. **å‘åå…¼å®¹**ï¼šä¸å½±å“ç°æœ‰åŠŸèƒ½ï¼Œæ–°å¢å­—æ®µå¯é€‰
3. **æ€§èƒ½ä¼˜åŒ–**ï¼šåœ¨çˆ¬å–é˜¶æ®µå°±è·å–æ—¶é—´ï¼Œé¿å…é¢å¤–è¯·æ±‚
4. **æ•°æ®ä¸€è‡´æ€§**ï¼šç¡®ä¿æ•°æ®åº“ä¸­çš„ä¼šè®®æ—¶é—´ä¸å®é™…ä¼šè®®æ—¶é—´ä¸€è‡´

## éƒ¨ç½²è¯´æ˜

1. ç¡®ä¿ `meeting_time.py` æ–‡ä»¶å­˜åœ¨ä¸”å¯è®¿é—®
2. é‡å¯åç«¯æœåŠ¡ä½¿ä¿®æ”¹ç”Ÿæ•ˆ
3. å‰ç«¯æ— éœ€ä¿®æ”¹ï¼Œå·²æ”¯æŒåŠ¨æ€æ—¶é—´æ˜¾ç¤º
4. è¿è¡Œæµ‹è¯•è„šæœ¬éªŒè¯åŠŸèƒ½ï¼š`python test_real_meeting_time.py`

## æ³¨æ„äº‹é¡¹

1. è…¾è®¯ä¼šè®® API è¿”å›çš„æ—¶é—´æˆ³ä¸º13ä½æ¯«ç§’çº§æ—¶é—´æˆ³
2. å¦‚æœæ— æ³•è·å–çœŸå®å¼€å§‹æ—¶é—´ï¼Œç³»ç»Ÿä¼šä½¿ç”¨å½“å‰æ—¶é—´ä½œä¸ºå…œåº•
3. å‰ç«¯æ’åºåˆ‡æ¢é€šè¿‡ `sortBy` çŠ¶æ€æ§åˆ¶ï¼Œå®æ—¶ç”Ÿæ•ˆ
4. æ•°æ®åº“ä¸­çš„ `Meeting.start_time` å­—æ®µç°åœ¨å­˜å‚¨çœŸå®ä¼šè®®å¼€å§‹æ—¶é—´