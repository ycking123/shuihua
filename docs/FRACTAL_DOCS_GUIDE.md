# 分形文档 + 强制同构系统 - 实施指南

## 概述

本项目已成功实施"分形文档 + 强制同构"系统，这是一个三层折叠的文档架构，确保 AI 能够从任意文件进入，通过三次 Read 获得完整上下文。

## 文档结构

### 第一层：全局地图 (MAP.md)
**位置**: 根目录 `/MAP.md`

**内容**:
- 项目定位和核心功能
- 模块结构总览
- 数据流向图
- 强制同构规则说明
- 快速定位表

### 第二层：模块文档 (各模块/MODULE.md)
**位置**: `/modules/MODULE.md`

**内容**:
- 模块职责说明
- 成员清单（文件列表）
- 接口说明（主要函数/组件）

**已创建的模块文档**:
- `/backend/MODULE.md` - 后端服务层
- `/server/MODULE.md` - API 路由层
- `/components/MODULE.md` - 前端组件层
- `/crawlers/MODULE.md` - 爬虫模块
- `/utils/MODULE.md` - 工具函数库

### 第三层：文件头声明
**位置**: 每个代码文件头部

**格式**:
```python
# ============================================================================
# 文件: filename.py
# 模块: module_name
# 职责: 简短描述
#
# 依赖声明:
#   - 外部: ...
#   - 本模块: ...
#
# 主要接口:
#   - function_name(): 描述
#
# ============================================================================
```

**已添加头部声明的文件**:
- `backend/url_crawler.py` - 会议爬虫
- `backend/ai_handler.py` - AI 分析
- `backend/server_receive.py` - 服务接收
- `server/main.py` - FastAPI 主入口
- `server/database.py` - 数据库连接
- `server/models.py` - ORM 模型
- `server/security.py` - 安全认证
- `components/TodoView.tsx` - 待办视图

## AI 上下文获取路径

```
AI 进入任意文件
    ↓
Read 1: 文件头声明 → 了解当前文件的职责和依赖
    ↓
Read 2: 模块 MODULE.md → 了解模块的成员清单和接口
    ↓
Read 3: 根目录 MAP.md → 了解全局架构和模块关系
    ↓
获得完整上下文 ✅
```

## 强制同构检查

### 检查脚本
**位置**: `/scripts/check_docs_sync.py`

**功能**:
1. 检查每个模块的 `MODULE.md` 成员清单是否与实际文件匹配
2. 检查代码文件头部的依赖声明是否存在
3. 报告不一致的地方

### 使用方法

**本地检查**:
```bash
python scripts/check_docs_sync.py
```

**CI/CD 集成**:
已配置 GitHub Actions 工作流，在每次 push 和 PR 时自动运行检查：
- 配置文件: `.github/workflows/docs-sync-check.yml`

### 检查输出示例

```
============================================================
🔍 分形文档强制同构检查
============================================================

📄 检查全局 MAP.md...
   ✅ MAP.md 检查通过

📦 检查模块 backend/...
   ⚠️  backend/MODULE.md 缺少文件: {'__init__.py'}
   ⚠️  D:\...\backend\__init__.py 缺少头部文档块

============================================================
❌ 发现 2 个问题
```

## 开发工作流

### 新增文件时
1. 创建文件时，在头部添加完整的文档块声明
2. 运行 `python scripts/check_docs_sync.py` 检查
3. 更新对应模块的 `MODULE.md`，添加新文件到成员清单

### 修改文件时
1. 修改代码后，检查文件头的依赖声明是否仍然准确
2. 运行检查脚本确认没有遗漏

### 删除文件时
1. 删除文件前，从对应模块的 `MODULE.md` 中移除该文件
2. 运行检查脚本确认同步

## 文档维护规则

### 强制同构原则
**每次代码变更后必须检查**：
1. ✅ 文件头部的依赖声明是否最新
2. ✅ 文件头部的职责说明是否准确
3. ✅ 模块 `MODULE.md` 的成员清单是否完整
4. ✅ 模块 `MODULE.md` 的接口说明是否同步

### 三轮会话失效防护
文档和代码是同一事物的两个相。任何一相变了，另一相没跟上：
- 1 轮会话后：AI 开始基于错误假设工作
- 2 轮会话后：AI 生成更多错误代码
- 3 轮会话后：AI 完全在错误上下文中工作

**解决方案**: 每次代码变更后立即运行检查脚本。

## 当前状态

### 已完成 ✅
- 创建全局地图 `MAP.md`
- 创建 5 个模块的 `MODULE.md`
- 为 8 个核心文件添加头部声明
- 创建强制同构检查脚本
- 配置 GitHub Actions 自动检查
- 更新 `README.md` 添加文档系统说明

### 待完善 ⚠️
根据最新检查结果，需要：
1. 为 `__init__.py` 文件添加头部声明（可选）
2. 为部分组件文件添加头部声明
3. 更新 `MODULE.md` 中的成员清单格式（移除多余的 `-----` 行）

## 相关文件

```
项目根目录/
├── MAP.md                                    # 全局地图
├── README.md                                 # 已更新文档说明
├── scripts/
│   └── check_docs_sync.py                   # 检查脚本
├── .github/
│   └── workflows/
│       └── docs-sync-check.yml              # CI 检查配置
├── backend/
│   ├── MODULE.md                            # 后端模块文档
│   ├── url_crawler.py                       # ✅ 已有头部声明
│   ├── ai_handler.py                        # ✅ 已有头部声明
│   └── server_receive.py                    # ✅ 已有头部声明
├── server/
│   ├── MODULE.md                            # 服务端模块文档
│   ├── main.py                              # ✅ 已有头部声明
│   ├── database.py                          # ✅ 已有头部声明
│   ├── models.py                            # ✅ 已有头部声明
│   └── security.py                          # ✅ 已有头部声明
├── components/
│   ├── MODULE.md                            # 组件模块文档
│   └── TodoView.tsx                         # ✅ 已有头部声明
├── crawlers/
│   └── MODULE.md                            # 爬虫模块文档
└── utils/
    └── MODULE.md                            # 工具模块文档
```

## 总结

通过实施"分形文档 + 强制同构"系统：

1. **上下文获取效率提升**: AI 从任意文件进入，3 次 Read 即可获得完整上下文
2. **文档同步性保障**: 自动化检查脚本确保文档与代码保持一致
3. **开发体验优化**: 清晰的依赖声明和职责说明降低代码理解成本

这套系统的核心价值在于：**将文档从"额外维护负担"转变为"代码的一部分"，通过强制同构确保两者始终保持同步。**
